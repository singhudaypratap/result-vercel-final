<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PIET — Result Lookup</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#f8fafc,#eef2ff);padding:28px;}
    .card{max-width:1100px;margin:0 auto;padding:20px;border-radius:12px;box-shadow:0 8px 28px rgba(16,24,40,0.06);background:white}
    .footer{font-size:13px;color:#556; text-align:center;margin-top:12px}
    table td, table th { vertical-align: middle; white-space:nowrap; }
    .grade-App { background: linear-gradient(90deg, #e6ffed, #d1ffe0); color:#064c2e; font-weight:600; }
    .grade-A { background: #e9f9f0; color:#06603a; }
    .grade-B { background: #fff7e6; color:#6b4a00; }
    .grade-C { background:#fff4f1; color:#7a2b1c; }
    .grade-F { background:#ffebee; color:#8b0000; font-weight:700;}
    .small-note { font-size:13px; color:#6b7280; }
    .table-wrap { overflow:auto; max-height:520px; }
    @media(max-width:880px){ table td, table th { font-size:12px; } }
  </style>
</head>
<body>
  <div class="card">
    <div class="d-flex align-items-start mb-3">
      <div>
        <h4 class="mb-0">PIET — Result Lookup</h4>
        <div class="small-note">Enter registration number and select branch</div>
      </div>
      <div class="ms-auto d-flex gap-2">
        <button id="downloadCSV" class="btn btn-outline-secondary btn-sm">Download CSV</button>
        <button id="printBtn" class="btn btn-outline-secondary btn-sm">Print</button>
      </div>
    </div>

    <div class="row g-3 align-items-end mb-3">
      <div class="col-md-6">
        <label class="form-label">Registration Number</label>
        <input id="reg" class="form-control" placeholder="PIET23AD001" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Branch</label>
        <select id="branch" class="form-select">
          <option>CS</option>
          <option>CSR-D</option>
          <option>AI&DS-E</option>
          <option>CS(AI)-F</option>
          <option>CS(DS)-G</option>
          <option>CS(IOT)-H</option>
        </select>
      </div>
      <div class="col-md-3 d-grid">
        <button id="btn" class="btn btn-primary">Get Result</button>
      </div>
    </div>

    <div id="msg" class="mb-2"></div>

    <div id="result-area" class="table-wrap">
      <!-- Table injected here -->
      <div class="text-center py-5" id="placeholder">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96'%3E%3Crect width='96' height='96' fill='%23eef2ff' rx='12'/%3E%3C/svg%3E" alt="" class="mb-3" />
        <div class="h6">No query yet</div>
        <div class="small-note">Enter registration number and click <strong>Get Result</strong>.</div>
      </div>
    </div>

    <div class="footer">Developed by <strong>Department of AI &amp; DS, PIET Jaipur</strong></div>
  </div>

<script>
/*
 Frontend logic:
 - call /api/result?reg=...&branch=...
 - take first row keys and map to an optimized ordered column list
 - detect subject columns and place them after core student info
 - final columns: Total Back, Result, SGPA moved to right
 - grade coloring helper
*/

const btn = document.getElementById('btn');
const regInput = document.getElementById('reg');
const branchSelect = document.getElementById('branch');
const resultArea = document.getElementById('result-area');
const msgDiv = document.getElementById('msg');
const downloadCSVBtn = document.getElementById('downloadCSV');
const printBtn = document.getElementById('printBtn');

const canonicalOrder = [
  ['reg','reg. no','reg no','regno','registration','registration no','reg. no.','registration number'],
  ['name','student name','candidate name'],
  ['uni-roll','uni-roll no','uni roll','uni roll no','uni-roll no','uni roll number','uni-roll-number','uni-roll-no'],
  ['col roll','college roll','col roll no','col-roll-no','colroll','section','class'],
];

const trailingCols = [
  ['total back','back','totalback','backlog','backlogs','total backlogs'],
  ['result','status'],
  ['sgpa','gpa','sgpa']
];

function findKeyForSynonyms(recordKeys, synonyms){
  const lk = recordKeys.map(k=>k.toLowerCase().trim());
  for(const s of synonyms){
    const sNorm = s.toLowerCase().trim();
    for(let i=0;i<lk.length;i++){
      if(lk[i] === sNorm) return recordKeys[i];
    }
    for(let i=0;i<lk.length;i++){
      if(lk[i].includes(sNorm) || sNorm.includes(lk[i])) return recordKeys[i];
    }
  }
  return null;
}

function gradeClass(g){
  if(!g) return '';
  const s = g.toString().trim().toUpperCase();
  if(s === 'A++' || s==='A+' ) return 'grade-App';
  if(s.startsWith('A')) return 'grade-A';
  if(s.startsWith('B')) return 'grade-B';
  if(s.startsWith('C') || s.startsWith('D')) return 'grade-C';
  if(s === 'F' || s.toLowerCase().includes('fail')) return 'grade-F';
  return '';
}

function buildTable(rows){
  if(!rows || rows.length===0){
    resultArea.innerHTML = '<div class="alert alert-info">No record found.</div>';
    return;
  }
  const first = rows[0];
  const keys = Object.keys(first);

  const orderedKeys = [];
  const used = new Set();

  for(const synList of canonicalOrder){
    const k = findKeyForSynonyms(keys, synList);
    if(k){ orderedKeys.push(k); used.add(k); }
  }

  const subjectKeys = [];
  for(const k of keys){
    if(used.has(k)) continue;
    const kn = k.toLowerCase();
    if(['index','sl','s.no','sno','sr','serial'].some(x=>kn===x)) { used.add(k); continue; }

    const isTrailing = trailingCols.some(syns => findKeyForSynonyms([k], syns));
    if(isTrailing) continue;

    if(/[0-9]/.test(k) && /[A-Za-z]/.test(k) || /cs|ee|ma|fe|fec|feco|fep/i.test(k) ) {
      subjectKeys.push(k);
      used.add(k);
    }
  }

  for(const k of keys){
    if(used.has(k)) continue;
    const isTrailing = trailingCols.some(syns => findKeyForSynonyms([k], syns));
    if(!isTrailing){
      subjectKeys.push(k);
      used.add(k);
    }
  }

  orderedKeys.push(...subjectKeys);

  for(const syns of trailingCols){
    const k = findKeyForSynonyms(keys, syns);
    if(k){ orderedKeys.push(k); used.add(k); }
  }

  if(!orderedKeys.some(k=>k.toLowerCase().includes('sgpa'))){
    const g = keys.find(k=>/gpa|sgpa|cgpa/i.test(k));
    if(g) orderedKeys.push(g);
  }

  let html = '<div class="table-responsive"><table class="table table-bordered table-hover table-sm"><thead class="table-light"><tr>';
  for(const col of orderedKeys){
    html += `<th>${escapeHtml(col)}</th>`;
  }
  html += '</tr></thead><tbody>';

  for(const r of rows){
    let totalBackKey = orderedKeys.find(k=>/back/i.test(k));
    let totalBackVal = totalBackKey ? r[totalBackKey] : null;
    if((totalBackVal === undefined || totalBackVal === '') && !totalBackKey){
      let backCount = 0;
      for(const sk of subjectKeys){
        const v = (r[sk]||'').toString().trim().toUpperCase();
        if(v === 'F' || v.indexOf('FAIL')!==-1) backCount++;
      }
      totalBackVal = backCount.toString();
    }

    html += '<tr>';
    for(const col of orderedKeys){
      let cell = r[col] !== undefined ? r[col] : '';
      if((/back/i.test(col) && (cell === undefined || cell === '')) && totalBackVal !== null){
        cell = totalBackVal;
      }
      const cl = gradeClass(cell);
      if(/result/i.test(col) && (typeof cell === 'string') && cell.trim().toLowerCase().startsWith('f')){
        html += `<td class="${cl}">${escapeHtml(cell)}</td>`;
      } else if(cl){
        html += `<td class="${cl}">${escapeHtml(cell)}</td>`;
      } else {
        html += `<td>${escapeHtml(cell)}</td>`;
      }
    }
    html += '</tr>';
  }

  html += '</tbody></table></div>';
  resultArea.innerHTML = html;
  setupCSV();
}

function escapeHtml(str){
  if(str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

btn.addEventListener('click', async () => {
  const reg = regInput.value.trim();
  const branch = branchSelect.value;
  resultArea.innerHTML = '';
  msgDiv.innerHTML = '';
  if(!reg){ msgDiv.innerHTML = '<div class="alert alert-warning">Please enter registration number.</div>'; return; }

  btn.disabled = true;
  btn.innerText = 'Searching...';
  try{
    const qs = new URLSearchParams({ reg, branch });
    const resp = await fetch(`/api/result?${qs.toString()}`);
    const data = await resp.json();
    if(resp.status === 200){
      const rows = data.result || [];
      buildTable(rows);
    } else {
      msgDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Request failed'}</div>`;
    }
  } catch(err){
    msgDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerText = 'Get Result';
  }
});

printBtn.addEventListener('click', () => window.print());

function setupCSV(){
  downloadCSVBtn.onclick = () => {
    const table = resultArea.querySelector('table');
    if(!table){ alert('No result table to download.'); return; }
    const rows = Array.from(table.querySelectorAll('tr'));
    const csv = rows.map(r => Array.from(r.querySelectorAll('th,td')).map(c => '"' + c.innerText.replace(/"/g,'""') + '"').join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'result.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
}

regInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { btn.click(); } });

</script>
</body>
</html>
